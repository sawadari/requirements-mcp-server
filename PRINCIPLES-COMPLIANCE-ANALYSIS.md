# REQUIREMENTS-PRINCIPLES.md 準拠性分析

## 分析日時
2025-10-21

## 概要

REQUIREMENTS-PRINCIPLES.mdで定義された要求管理の要諦に対して、現在のアーキテクチャと実装、既存イシューの準拠性を評価し、ギャップを特定する。

---

## 1. オントロジー準拠性の評価

### ✅ 適合している点

#### 1.1 要求の段階的詳細化
- **現状**: 要求の`type`フィールドで段階を表現（`stakeholder`, `system`, `functional`）
- **評価**: ステークホルダ要求→システム要求→システム機能要求の3段階を実装
- **証拠**: `src/types.ts` の Requirement 型定義

#### 1.2 親子関係とMECE原則
- **現状**: `parent_id`, `children`フィールドで階層構造を実装
- **評価**: MECEValidatorが親子関係の整合性を検証
- **証拠**: `src/validation/mece-validator.ts`

#### 1.3 要求の分解と統合
- **現状**: Fix Engineで`split`と`merge`操作を実装
- **評価**: ChangeSetによる可逆的な分解・統合が可能
- **証拠**: `src/fix-engine/change-engine.ts`

### ⚠️ 部分的に適合している点

#### 1.4 粒度の一貫性検証
- **現状**: NLPAnalyzerで抽象度を分析
- **問題**: 同一段階内での粒度（文章の長さ、抽象度）の一貫性を強制する仕組みが弱い
- **ギャップ**:
  - 兄弟要求間の粒度比較が不十分
  - 文章の長さのバリデーションがない
  - 抽象度の統一が検証されていない

**推奨**: 新規イシュー作成が必要

---

## 2. セマンティクス準拠性の評価

### ✅ 適合している点

#### 2.1 要求の構成要素
- **現状**: `title`, `description`, `rationale`フィールドを実装
- **評価**: 主題、説明、理由を表現可能
- **証拠**: `src/types.ts` の Requirement 型

#### 2.2 属性のカスタマイズ
- **現状**: `metadata?: Record<string, any>`で拡張属性をサポート
- **評価**: 要求の段階やプロジェクト固有の属性追加が可能
- **証拠**: メタデータフィールドの存在

### ⚠️ 部分的に適合している点

#### 2.3 段階別属性のカスタマイズ
- **現状**: 全要求で同じ属性セット
- **問題**: ステークホルダ要求、システム要求、システム機能要求で属性を変えられない
- **ギャップ**:
  - 段階別の必須フィールドが定義されていない
  - 段階別のバリデーションルールが不足
  - 段階別のテンプレートがない

**推奨**: 新規イシュー作成が必要

---

## 3. 妥当性準拠性の評価

### ✅ 適合している点

#### 3.1 構造的妥当性
- **現状**: StructureValidatorで構造の妥当性を検証
- **評価**: オントロジーへの適合を確認
- **証拠**: `src/validation/structure-validator.ts`

#### 3.2 意味的整合性
- **現状**: LLMEvaluatorで意味的整合性を評価（部分実装）
- **評価**: 連続性、整合性、論理性の検証を目指している
- **証拠**: `src/validation/llm-evaluator.ts`

### ⚠️ 部分的に適合している点

#### 3.3 LLM評価の完全実装
- **現状**: LLMEvaluatorは未実装（TODOコメント）
- **問題**: 意味的整合性の自動評価が機能していない
- **ギャップ**: Issue #13で対応予定だが、優先度がMedium

**推奨**: Issue #13の優先度をHighに変更

---

## 4. ツール的側面の準拠性評価

### ✅ 適合している点

#### 4.1 影響分析
- **現状**: ImpactAnalyzerで影響範囲を分析
- **評価**: 親・子・兄弟・横依存を追跡
- **証拠**: `src/analyzer.ts`

#### 4.2 整合性の自動維持
- **現状**: Fix Engineで自動修正をサポート
- **評価**: ChangeSetによる整合性維持
- **証拠**: `src/fix-engine/`

### ⚠️ 部分的に適合している点

#### 4.3 トレーサビリティ
- **現状**: OperationLoggerで操作履歴を記録
- **問題**: トランザクションログが未実装
- **ギャップ**: Issue #7で対応予定

**推奨**: 現状のイシューで対応可能

---

## 5. 可変性準拠性の評価

### ⚠️ 部分的に適合している点

#### 5.1 オントロジーの可変性
- **現状**: 要求の段階は`type`フィールドでハードコーディング
- **問題**: オントロジーの定義を外部から変更できない
- **ギャップ**:
  - 要求の段階を動的に定義できない
  - 段階の追加・削除ができない
  - プロジェクト固有のオントロジーが定義できない

**推奨**: 新規イシュー作成が必要

#### 5.2 セマンティクスの可変性
- **現状**: メタデータフィールドで部分的に対応
- **問題**: 段階別の属性定義が固定
- **ギャップ**:
  - 必須フィールドをカスタマイズできない
  - バリデーションルールを外部定義できない

**推奨**: 設定管理の外部化（Issue #12）で対応可能

---

## 6. 運用シチュエーション準拠性の評価

### ✅ 適合している点

#### 6.1 初期設定
- **現状**: fix-policy.jsoncでポリシーを定義
- **評価**: ルール化とルール設定が可能
- **証拠**: `fix-policy.jsonc`

#### 6.2 要求構造の構築
- **現状**: MCPツールで要求の追加・派生・洗練が可能
- **評価**: トップダウンアプローチをサポート
- **証拠**: `add_requirement`, `update_requirement`

#### 6.3 継続的メンテナンス
- **現状**: 影響分析と自動修正をサポート
- **評価**: 効率的なメンテナンスが可能
- **証拠**: `analyze_impact`, `apply_fixes`

### ❌ 適合していない点

#### 6.4 オントロジーとセマンティクスの動的設定
- **現状**: システム起動前に決定される
- **問題**: 特定システムごとにオントロジーとセマンティクスを設定する仕組みがない
- **ギャップ**:
  - プロジェクト設定ファイルがない
  - オントロジー定義ファイルがない
  - セマンティクス定義ファイルがない

**推奨**: 新規イシュー作成が必要

---

## 7. ギャップサマリー

### 重大なギャップ（新規イシュー作成が必要）

#### Gap-1: オントロジーの外部定義とカスタマイズ
**重要度**: High
**内容**:
- 要求の段階を動的に定義できない
- プロジェクト固有のオントロジーが設定できない
- オントロジー定義ファイルが存在しない

**影響**:
- 異なるドメインへの適用が困難
- システムタイプごとのカスタマイズができない
- 再利用性が低い

**推奨アクション**: 新規Issue作成
- `ontology-schema.json` の導入
- オントロジーバリデーターの実装
- 段階別ルールの動的ロード

#### Gap-2: 段階別セマンティクスのカスタマイズ
**重要度**: High
**内容**:
- 各段階で異なる属性セットを定義できない
- 段階別の必須フィールド、バリデーションルールがない
- 段階別テンプレートがない

**影響**:
- 要求の段階に応じた品質管理ができない
- ステークホルダ要求とシステム機能要求で同じ属性セット

**推奨アクション**: 新規Issue作成
- `semantics-schema.json` の導入
- 段階別バリデーションルールの実装
- 段階別テンプレート機能

#### Gap-3: 粒度の一貫性検証
**重要度**: Medium
**内容**:
- 同一段階内の粒度一貫性を強制する仕組みが弱い
- 文章の長さ、抽象度の統一が検証されない
- 兄弟要求間の粒度比較が不十分

**影響**:
- 要求の品質がばらつく
- レビュー負荷が高い

**推奨アクション**: 新規Issue作成
- 文章長のバリデーター実装
- 抽象度の統一チェック
- 兄弟要求の粒度比較機能

### 既存イシューで対応可能なギャップ

#### Gap-4: LLM評価の未実装
**対応イシュー**: #13 - LLM Evaluatorの実装
**推奨**: 優先度をMedium→Highに変更

#### Gap-5: トランザクションログ
**対応イシュー**: #7 - Phase 2 - トランザクションログの実装
**推奨**: 現状のまま

#### Gap-6: 設定管理の外部化
**対応イシュー**: #12 - Phase 4 - 設定管理の外部化
**推奨**: セマンティクス定義も含めるよう拡張

---

## 8. 推奨アクションプラン

### 即時対応（1週間以内）

1. **新規Issue作成**: オントロジーの外部定義とカスタマイズ（Gap-1）
2. **新規Issue作成**: 段階別セマンティクスのカスタマイズ（Gap-2）
3. **Issue #13の優先度変更**: Medium→High
4. **Issue #12の拡張**: セマンティクス定義を含める

### 短期対応（1ヶ月以内）

5. **新規Issue作成**: 粒度の一貫性検証（Gap-3）
6. **ARCHITECTURE.md更新**: 原則文書への参照を追加
7. **FIX-ENGINE-README.md更新**: 原則文書との対応関係を明記

### 中期対応（3ヶ月以内）

8. 全イシューの実装
9. 統合テストでの原則準拠性検証
10. ドキュメントの整合性確保

---

## 9. アーキテクチャドキュメントへの推奨修正

### ARCHITECTURE.mdに追加すべきセクション

#### 9.1 要求管理の基本原則
```markdown
## 要求管理の基本原則

本システムは [REQUIREMENTS-PRINCIPLES.md](./REQUIREMENTS-PRINCIPLES.md) で定義された要諦に基づいて設計されています。

### オントロジー
- 要求の段階: ステークホルダ要求 → システム要求 → システム機能要求
- MECE原則: 親子関係の完全性と排他性
- 粒度の一貫性: 同一段階内での統一

### セマンティクス
- 要求の構成: 主題・説明・理由・属性
- 段階別カスタマイズ: プロジェクト固有の属性定義

### 妥当性
- 構造的妥当性: オントロジーへの適合
- 意味的整合性: 連続性・整合性・論理性

詳細は [REQUIREMENTS-PRINCIPLES.md](./REQUIREMENTS-PRINCIPLES.md) を参照。
```

#### 9.2 原則の実装マッピング
```markdown
## 原則の実装マッピング

| 原則 | 実装コンポーネント | ファイル |
|------|-------------------|----------|
| 段階的詳細化 | Requirement.type | src/types.ts |
| MECE原則 | MECEValidator | src/validation/mece-validator.ts |
| 影響分析 | ImpactAnalyzer | src/analyzer.ts |
| 自動修正 | Fix Engine | src/fix-engine/ |
| トレーサビリティ | OperationLogger | src/operation-logger.ts |
```

---

## 10. まとめ

### 総合評価

**適合度**: 70% (7/10点)

- ✅ 完全適合: 3項目
- ⚠️ 部分適合: 4項目
- ❌ 不適合: 3項目

### 主要な強み

1. Fix Engineによる自動修正機構
2. MECE原則の検証機能
3. 影響分析の実装

### 主要な課題

1. オントロジーの外部定義機能の欠如
2. 段階別セマンティクスのカスタマイズ不足
3. LLM評価の未実装

### 次のステップ

1. **新規イシュー3件の作成** (Gap-1, Gap-2, Gap-3)
2. **Issue #13の優先度変更**
3. **Issue #12の拡張**
4. **アーキテクチャドキュメントの更新**

これにより、REQUIREMENTS-PRINCIPLES.mdへの完全準拠を目指す。

---

最終更新: 2025-10-21
バージョン: 1.0.0
