/**
 * View Server - „Éñ„É©„Ç¶„Ç∂„Åß„Éì„É•„Éº„ÇíË°®Á§∫„Åô„ÇãWeb„Çµ„Éº„Éê„Éº
 *
 */

import dotenv from 'dotenv';
dotenv.config();

import express from 'express';
import cors from 'cors';
import path from 'path';
import fs from 'fs/promises';
import chokidar from 'chokidar';
import { marked } from 'marked';
import { OperationLogger } from './operation-logger.js';
import { RequirementsStorage } from './storage.js';
import { TreeBuilder } from './tree-view.js';
import { RequirementValidator } from './validator.js';
import { ValidationEngine } from './validation/validation-engine.js';
import { createChatAssistant } from './ai-chat-assistant.js';
import { createEnhancedChatAssistant, EnhancedAIChatAssistant } from './enhanced-chat-assistant.js';
import { createMCPChatAssistant, MCPChatAssistant } from './mcp-chat-assistant.js';

const app = express();
const PORT = 5002;
const storage = new RequirementsStorage('./data');
const validator = new RequirementValidator(storage);

// ValidationEngine for AI Chat Assistant
let validationEngine: ValidationEngine;
let chatAssistant: ReturnType<typeof createChatAssistant>;
let enhancedChatAssistant: EnhancedAIChatAssistant;
let enhancedChatReady = false;
let chatAssistantReady = false;
let mcpChatAssistant: MCPChatAssistant | null = null;
let mcpChatReady = false;

// Initialize ValidationEngine and AI Chat Assistant asynchronously
const initChatAssistant = (async () => {
  validationEngine = await ValidationEngine.create();
  chatAssistant = createChatAssistant(storage, validationEngine);
  enhancedChatAssistant = createEnhancedChatAssistant(storage, validationEngine);
  enhancedChatReady = true;
  chatAssistantReady = true;
  console.log('‚úÖ AI Chat Assistant initialized');
  console.log('‚úÖ Enhanced Chat Assistant (Orchestrator) initialized');

  // Initialize MCP Chat Assistant (fallback to Enhanced if it fails)
  try {
    mcpChatAssistant = await createMCPChatAssistant();
    mcpChatReady = true;
    console.log('‚úÖ MCP Chat Assistant initialized');
  } catch (error: any) {
    console.warn('‚ö†Ô∏è  MCP Chat Assistant initialization failed:', error.message);
    console.warn('    Falling back to Enhanced Chat Assistant');
  }
})();

// Helper to ensure chat assistant is ready
async function ensureChatAssistantReady() {
  if (!chatAssistantReady) {
    await initChatAssistant;
  }
  return chatAssistant;
}

// CORSÊúâÂäπÂåñ
app.use(cors());
app.use(express.json());

// ÈùôÁöÑ„Éï„Ç°„Ç§„É´Êèê‰æõ
app.use('/views', express.static(path.join(process.cwd(), 'views')));

// „Éì„É•„ÉºÂÆöÁæ©
const VIEWS = [
  { id: 'stakeholder-requirements', name: '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç„É™„Çπ„Éà', icon: 'üë•' },
  { id: 'system-requirements', name: '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç„É™„Çπ„Éà', icon: '‚öôÔ∏è' },
  { id: 'system-functional-requirements', name: '„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç„É™„Çπ„Éà', icon: 'üîß' },
  { id: 'all-requirements', name: 'ÂÖ®Ë¶ÅÊ±Ç‰∏ÄË¶ß', icon: 'üìã' },
  { id: 'stakeholder-system-matrix', name: '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ-„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç„Éû„Éà„É™„ÉÉ„ÇØ„Çπ', icon: 'üìä' },
  { id: 'system-functional-matrix', name: '„Ç∑„Çπ„ÉÜ„É†-Ê©üËÉΩË¶ÅÊ±Ç„Éû„Éà„É™„ÉÉ„ÇØ„Çπ', icon: 'üìà' },
  { id: 'critical-requirements', name: 'ÈáçË¶ÅÂ∫¶CriticalË¶ÅÊ±Ç', icon: 'üö®' },
  { id: 'in-progress-requirements', name: 'ÂÆüË£Ö‰∏≠Ë¶ÅÊ±Ç', icon: 'üîÑ' },
  { id: 'operation-logs', name: 'Êìç‰ΩúÂ±•Ê≠¥Ôºà„Éá„Éê„ÉÉ„Ç∞Ôºâ', icon: 'üîç' },
];

// „É°„Ç§„É≥„Éö„Éº„Ç∏Ôºà„ÉÑ„É™„Éº„Éì„É•„ÉºÔºâ
app.get('/', (req, res) => {
  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ë¶ÅÊ±Ç„ÉÑ„É™„Éº„Éì„É•„Éº</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* ChatGPT/Codex style - minimal colors */
      --primary: #10a37f;
      --bg: #ffffff;
      --sidebar-bg: #f7f7f8;
      --surface: #ffffff;
      --text: #202123;
      --text-secondary: #6e6e80;
      --border: #e5e5e5;
      --shadow: rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‰∏äÊÆµ: „ÉÑ„É™„Éº„Å®Ë©≥Á¥∞ */
    .top-row {
      display: flex;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }

    /* Â∑¶ÂÅ¥„ÅÆ„ÉÑ„É™„Éº„Éë„Éç„É´ */
    .tree-panel {
      width: 320px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Search Panel - Ë©≥Á¥∞„Éì„É•„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ */
    .search-panel {
      flex: 0 0 auto;
      height: 400px;
      min-height: 200px;
      max-height: 800px;
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-radius: 12px;
      margin-top: 24px;
      position: relative;
    }

    .search-resizer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      cursor: ns-resize;
      background: var(--border);
      z-index: 10;
      border-top: 2px solid var(--border);
      border-bottom: 2px solid var(--border);
    }

    .search-resizer:hover {
      background: var(--primary);
      border-color: var(--primary);
      opacity: 0.8;
    }

    .search-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .search-filters {
      padding: 10px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .search-filters input,
    .search-filters select {
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
      background: var(--bg);
    }

    .search-filters input {
      flex: 1;
      min-width: 200px;
    }

    .search-filters select {
      min-width: 140px;
    }

    .search-filters button {
      padding: 8px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .search-filters button:hover {
      opacity: 0.9;
    }

    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .search-result-item {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg);
    }

    .search-result-item:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .search-result-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
    }

    .search-result-id {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .search-result-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .search-result-category {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .search-result-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .panel-header {
      padding: 10px 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .panel-header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .panel-header p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .tree-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    /* „Ç∞„É´„Éº„Éó„Éò„ÉÉ„ÉÄ„Éº */
    .tree-group-header {
      cursor: pointer;
      padding: 7px 8px;
      margin: 6px 0 4px 0;
      background: linear-gradient(90deg, var(--surface-light) 0%, var(--surface) 100%);
      border: 2px solid var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.2s ease;
      user-select: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .tree-group-header:hover {
      background: linear-gradient(90deg, var(--border) 0%, var(--surface-light) 100%);
      border-color: var(--primary);
      transform: translateX(2px);
    }

    .tree-group-header:active {
      transform: scale(0.98);
    }

    .tree-group-icon {
      font-size: 14px;
      color: var(--primary);
      font-weight: bold;
      width: 20px;
      text-align: center;
      transition: transform 0.2s ease;
    }

    .tree-group-title {
      flex: 1;
      letter-spacing: 0.3px;
    }

    .tree-group-count {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      background: var(--surface);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .tree-group-content {
      padding-left: 16px;
      margin-bottom: 8px;
      max-height: 5000px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
      opacity: 1;
    }

    .tree-group-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    /* „ÉÑ„É™„Éº„Ç¢„Ç§„ÉÜ„É† */
    .tree-item {
      cursor: pointer;
      padding: 4px 6px;
      margin: 2px 0;
      border-radius: 5px;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      position: relative;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid transparent;
    }

    .tree-item:hover {
      background: var(--surface-light);
      border-color: var(--border);
      transform: translateX(4px);
    }

    .tree-item.selected {
      background: var(--primary);
      border-color: var(--primary);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .tree-item.stakeholder {
      border-left: 4px solid var(--stakeholder-color);
      padding-left: 12px;
    }

    .tree-item.system {
      border-left: 4px solid var(--system-color);
      padding-left: 12px;
    }

    .tree-item.functional {
      border-left: 4px solid var(--functional-color);
      padding-left: 12px;
    }

    .tree-item-icon {
      font-size: 14px;
      flex-shrink: 0;
      opacity: 0.8;
    }

    .tree-item-title {
      flex: 1;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 400;
    }

    .tree-item-id {
      font-size: 10px;
      color: var(--text-secondary);
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.2);
      padding: 2px 6px;
      border-radius: 3px;
    }

    /* Âè≥ÂÅ¥„ÅÆË©≥Á¥∞„Éë„Éç„É´ */
    .detail-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .detail-header {
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .detail-header h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .detail-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detail-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }

    .detail-column-left,
    .detail-column-right {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .detail-section {
      background: var(--surface);
      padding: 10px;
      border-radius: 8px;
      margin-top: 0;
    }

    .detail-section h3 {
      font-size: 15px;
      margin-bottom: 6px;
      margin-top: 0;
      color: var(--text);
    }

    .relations-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .detail-field {
      margin-bottom: 6px;
    }

    .detail-field-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .detail-field-value {
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
    }

    .badge-status {
      background: var(--primary);
      color: white;
    }

    .badge-priority-critical {
      background: var(--danger);
      color: white;
    }

    .badge-priority-high {
      background: var(--warning);
      color: white;
    }

    .badge-priority-medium {
      background: var(--success);
      color: white;
    }

    .badge-priority-low {
      background: var(--surface-light);
      color: var(--text);
    }

    .badge-type {
      background: var(--secondary);
      color: white;
    }

    .tag-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag {
      padding: 4px 10px;
      background: var(--surface-light);
      border-radius: 4px;
      font-size: 12px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      text-align: center;
      padding: 32px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
    }

    .relation-link {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      margin: 6px 0;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 10px;
    }

    .relation-link:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .relation-link-icon {
      font-size: 14px;
      flex-shrink: 0;
    }

    .relation-link-content {
      flex: 1;
      min-width: 0;
    }

    .relation-link-id {
      font-size: 11px;
      font-family: 'Courier New', monospace;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }

    .relation-link-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .relation-link-meta {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .relation-link-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.2);
    }

    /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--surface-light);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border);
    }

    .legend {
      padding: 16px;
      background: var(--surface-light);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .legend-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .legend-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 3px;
      border-radius: 2px;
    }

    .legend-color.stakeholder {
      background: var(--stakeholder-color);
    }

    .legend-color.system {
      background: var(--system-color);
    }

    .legend-color.functional {
      background: var(--functional-color);
    }

    /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ - ChatGPTÈ¢® */
    .tab-navigation {
      display: none; /* „Çµ„Ç§„Éâ„Éê„Éº„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Å´ÁΩÆ„ÅçÊèõ„Åà */
    }

    .tab-button {
      display: none;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .tab-content.active {
      display: flex;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„Éë„Éç„É´ */
    .chat-panel {
      min-width: 300px;
      max-width: 800px;
      width: 400px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: none; /* „Éá„Éï„Ç©„É´„Éà„ÅßÈùûË°®Á§∫ - „Ç™„Éó„Ç∑„Éß„É≥Ê©üËÉΩ„Å®„Åó„Å¶Â∞ÜÊù•ÁöÑ„Å´ÊúâÂäπÂåñÂèØËÉΩ */
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .chat-resizer {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: ew-resize;
      background: transparent;
      z-index: 10;
    }

    .chat-resizer:hover,
    .chat-resizer.resizing {
      background: var(--primary);
    }

    .chat-header {
      padding: 20px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .chat-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message-avatar.user {
      background: var(--text-secondary);
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    .message-text {
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message-time {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .chat-input-container {
      padding: 16px 24px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .chat-input:focus {
      border-color: var(--primary);
    }

    .chat-send-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-send-btn:hover {
      background: var(--primary-hover);
    }

    .chat-send-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <!-- ‰∏äÊÆµ: „ÉÑ„É™„Éº„Å®Ë©≥Á¥∞ -->
      <div class="top-row">
        <!-- Â∑¶ÂÅ¥: „ÉÑ„É™„Éº„Éë„Éç„É´ -->
        <div class="tree-panel" id="treePanel">
        <div class="panel-header">
          <h1>üå≥ Items</h1>
          <div style="margin-top: 12px; padding: 10px; background: rgba(16, 163, 127, 0.1); border-radius: 8px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block;">üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„Éà</label>
            <select id="projectSelect" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px; cursor: pointer;">
              <option value="">Ë™≠„ÅøËæº„Åø‰∏≠...</option>
            </select>
            <span id="projectBadge" style="display: inline-block; margin-top: 6px; padding: 4px 8px; background: rgba(16, 163, 127, 0.2); border: 1px solid rgba(16, 163, 127, 0.4); border-radius: 4px; font-size: 11px; font-weight: 600; color: var(--primary);">ÁèæÂú®: --</span>
          </div>
        </div>
      <div class="tree-content">
        <div id="treeContainer"></div>
      </div>
    </div>

        <!-- Âè≥ÂÅ¥: Ë©≥Á¥∞„Éë„Éç„É´ -->
        <div class="detail-panel">
          <div class="detail-header" id="detailHeader">
            <h2>Ë¶ÅÊ±Ç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
          </div>
          <div class="detail-body" id="detailBody" style="display: flex; align-items: center; justify-content: center;">
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-text">Â∑¶ÂÅ¥„ÅÆ„ÉÑ„É™„Éº„Åã„ÇâË¶ÅÊ±Ç„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ<br>Ë©≥Á¥∞ÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
            </div>
          </div>

          <!-- Search Panel - Ë©≥Á¥∞„Éì„É•„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ -->
          <div class="search-panel" id="searchPanel">
        <div class="search-resizer" id="searchResizer"></div>
        <div class="search-content">
          <div class="search-filters">
            <input type="text" id="searchKeyword" placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢..." />
            <select id="filterStatus">
              <option value="">ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ</option>
              <option value="approved">ÊâøË™çÊ∏à„Åø</option>
              <option value="draft">„Éâ„É©„Éï„Éà</option>
              <option value="review">„É¨„Éì„É•„Éº‰∏≠</option>
            </select>
            <select id="filterPriority">
              <option value="">ÂÖ®„Å¶„ÅÆÂÑ™ÂÖàÂ∫¶</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="filterCategory">
              <option value="">ÂÖ®„Å¶„ÅÆ„Ç´„ÉÜ„Ç¥„É™</option>
              <option value="stakeholder">„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç</option>
              <option value="system">„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç</option>
              <option value="functional">„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç</option>
            </select>
            <select id="filterAuthor">
              <option value="">ÂÖ®„Å¶„ÅÆ‰ΩúÊàêËÄÖ</option>
            </select>
            <input type="text" id="filterTags" placeholder="„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä)" style="min-width: 150px;" />
            <select id="viewMode">
              <option value="list">„É™„Çπ„Éà</option>
              <option value="matrix-stakeholder-system">„Éû„Éà„É™„ÉÉ„ÇØ„Çπ: „Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ‚Üí„Ç∑„Çπ„ÉÜ„É†</option>
              <option value="matrix-system-functional">„Éû„Éà„É™„ÉÉ„ÇØ„Çπ: „Ç∑„Çπ„ÉÜ„É†‚ÜíÊ©üËÉΩ</option>
            </select>
            <button id="searchBtn">Ê§úÁ¥¢</button>
          </div>
          <div id="searchResults" class="search-results">
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <div class="empty-state-text">Ê§úÁ¥¢Êù°‰ª∂„ÇíË®≠ÂÆö„Åó„Å¶„ÄåÊ§úÁ¥¢„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
          </div>
        </div>
      </div>
        </div>
      </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„Éà„Éë„Éç„É´ -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-resizer" id="chatResizer"></div>
      <div class="chat-header">
        <h2>üí¨ Chat</h2>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message">
          <div class="message-avatar">C</div>
          <div class="message-content">
            <div class="message-text">„Åì„Çì„Å´„Å°„ÅØÔºÅË¶ÅÊ±ÇÁÆ°ÁêÜ„ÅÆ„ÅäÊâã‰ºù„ÅÑ„Çí„Åó„Åæ„Åô„ÄÇ

‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™Ë≥™Âïè„Å´„ÅäÁ≠î„Åà„Åß„Åç„Åæ„Åô:
‚Ä¢ Êñ∞„Åó„ÅÑË¶ÅÊ±Ç„ÅÆËøΩÂä†
‚Ä¢ Ë¶ÅÊ±Ç„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
‚Ä¢ ‰æùÂ≠òÈñ¢‰øÇ„ÅÆÂàÜÊûê
‚Ä¢ Ë¶ÅÊ±Ç„ÅÆÊ§úÁ¥¢„Éª„Éï„Ç£„É´„Çø

‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</div>
            <div class="message-time">‰ªä</div>
          </div>
        </div>
      </div>
      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea
            id="chatInput"
            class="chat-input"
            placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
            rows="1"
          ></textarea>
          <button id="chatSend" class="chat-send-btn">‚Üë</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedRequirement = null;
    let allRequirements = []; // Store all requirements for search
    let currentProject = null;

    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜÊ©üËÉΩ
    async function loadProjects() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();

        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '';

        data.projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.projectId;
          const displayName = project.systemName
            ? \`\${project.systemName} - \${project.projectName} (\${project.requirementCount}‰ª∂)\`
            : \`\${project.projectName} (\${project.requirementCount}‰ª∂)\`;
          option.textContent = displayName;
          if (project.isCurrent) {
            option.selected = true;
            currentProject = project;
            updateProjectBadge(project);
          }
          projectSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load projects:', error);
      }
    }

    function updateProjectBadge(project) {
      const badge = document.getElementById('projectBadge');
      const displayText = project.systemName
        ? \`ÁèæÂú®: \${project.systemName} - \${project.projectName}\`
        : \`ÁèæÂú®: \${project.projectName}\`;
      badge.textContent = displayText;
    }

    async function switchProject(projectId) {
      if (!projectId || (currentProject && projectId === currentProject.projectId)) {
        return;
      }

      try {
        const response = await fetch('/api/project/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId })
        });

        const data = await response.json();

        if (data.success) {
          currentProject = data.project;
          updateProjectBadge(data.project);

          // „ÉÑ„É™„Éº„Å®„Éá„Éº„Çø„Çí„É™„É≠„Éº„Éâ
          await loadTree();

          // Ë©≥Á¥∞„Éë„Éç„É´„Çí„ÇØ„É™„Ç¢
          selectedRequirement = null;
          document.getElementById('detailHeader').innerHTML = '<h2>Ë¶ÅÊ±Ç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>';
          document.getElementById('detailBody').innerHTML = \`
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <div class="empty-state-text">Â∑¶ÂÅ¥„ÅÆ„ÉÑ„É™„Éº„Åã„ÇâË¶ÅÊ±Ç„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ<br>Ë©≥Á¥∞ÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
            </div>
          \`;
        } else {
          alert(\`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà„Ç®„É©„Éº: \${data.error}\`);
        }
      } catch (error) {
        console.error('Failed to switch project:', error);
        alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }

    document.getElementById('projectSelect').addEventListener('change', (e) => {
      switchProject(e.target.value);
    });

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÂèñÂæó
    loadProjects();

    // View switching functionality
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const view = item.getAttribute('data-view');

        // Update active state
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        // Note: Search„Éë„Éç„É´„ÅØÂ∏∏„Å´Ë°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü„Åü„ÇÅ„ÄÅ
        // „Éì„É•„ÉºÂàá„ÇäÊõø„Åà„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂâäÈô§„Åó„Åæ„Åó„Åü
      });
    });

    // Search functionality
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const keyword = document.getElementById('searchKeyword').value;
      const status = document.getElementById('filterStatus').value;
      const priority = document.getElementById('filterPriority').value;
      const category = document.getElementById('filterCategory').value;
      const author = document.getElementById('filterAuthor').value;
      const tagsInput = document.getElementById('filterTags').value;
      const viewMode = document.getElementById('viewMode').value;

      // Filter requirements
      let results = allRequirements.filter(req => {
        let match = true;

        if (keyword) {
          const searchText = keyword.toLowerCase();
          match = match && (
            req.title.toLowerCase().includes(searchText) ||
            req.description.toLowerCase().includes(searchText) ||
            req.id.toLowerCase().includes(searchText)
          );
        }

        if (status) {
          match = match && req.status === status;
        }

        if (priority) {
          match = match && req.priority === priority;
        }

        if (category) {
          // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàËã±Ë™û‚ÜíÊó•Êú¨Ë™ûÔºâ
          const categoryMap = {
            'stakeholder': '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ',
            'system': '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç',
            'functional': 'Ê©üËÉΩ'
          };
          const searchTerm = categoryMap[category] || category;
          const reqCategory = req.category ? req.category : '';
          match = match && reqCategory.includes(searchTerm);
        }

        if (author) {
          match = match && req.author === author;
        }

        if (tagsInput) {
          const searchTags = tagsInput.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
          if (searchTags.length > 0 && req.tags && req.tags.length > 0) {
            const reqTags = req.tags.map(t => t.toLowerCase());
            match = match && searchTags.some(st => reqTags.some(rt => rt.includes(st)));
          } else if (searchTags.length > 0) {
            match = false;
          }
        }

        return match;
      });

      // „Éì„É•„Éº„É¢„Éº„Éâ„Å´Âøú„Åò„Å¶Ë°®Á§∫
      if (viewMode === 'list') {
        renderSearchResults(results);
      } else if (viewMode.startsWith('matrix-')) {
        renderMatrixView(results, viewMode);
      }
    });

    // Render search results
    function renderSearchResults(results) {
      const container = document.getElementById('searchResults');

      if (results.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div></div>';
        return;
      }

      const categoryColors = {
        stakeholder: 'background: #e3f2fd; color: #1565c0;',
        system: 'background: #f3e5f5; color: #6a1b9a;',
        functional: 'background: #e8f5e9; color: #2e7d32;'
      };

      const html = results.map(req => {
        const desc = req.description.substring(0, 100) + (req.description.length > 100 ? '...' : '');
        const categoryStyle = categoryColors[req.category] || '';
        return '<div class="search-result-item" data-id="' + req.id + '"><div class="search-result-header"><span class="search-result-id">' + req.id + '</span><span class="search-result-title">' + req.title + '</span><span class="search-result-category" style="' + categoryStyle + '">' + req.category + '</span></div><div class="search-result-description">' + desc + '</div></div>';
      }).join('');

      container.innerHTML = html;

      // Add click handlers to search results
      container.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', async () => {
          const reqId = item.getAttribute('data-id');
          const req = allRequirements.find(r => r.id === reqId);
          if (req) {
            // Load and select the requirement
            await loadAndSelectRequirement(reqId);
          }
        });
      });
    }

    // „Éû„Éà„É™„ÉÉ„ÇØ„Çπ„Éì„É•„Éº„ÇíË°®Á§∫
    function renderMatrixView(results, viewMode) {
      const container = document.getElementById('searchResults');

      let rowType, colType, rowName, colName, rowIdPrefix, colIdPrefix;
      if (viewMode === 'matrix-stakeholder-system') {
        rowType = 'stakeholder';
        colType = 'system';
        rowName = '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç';
        colName = '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç';
        rowIdPrefix = 'STK-';
        colIdPrefix = 'SYS-';
      } else if (viewMode === 'matrix-system-functional') {
        rowType = 'system';
        colType = 'functional';
        rowName = '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç';
        colName = '„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç';
        rowIdPrefix = 'SYS-';
        colIdPrefix = 'FUNC-';
      }

      // „Éû„Éà„É™„ÉÉ„ÇØ„Çπ„Éì„É•„Éº„Åß„ÅØÂÖ®Ë¶ÅÊ±Ç„Åã„ÇâÊäΩÂá∫Ôºàresults„Åß„ÅØ„Å™„ÅèallRequirementsÔºâ
      const rows = allRequirements.filter(req => {
        const category = req.category ? req.category.toLowerCase() : '';
        const id = req.id ? req.id.toUpperCase() : '';
        return category.includes(rowType) ||
               category.includes(rowName) ||
               id.startsWith(rowIdPrefix);
      });

      const cols = allRequirements.filter(req => {
        const category = req.category ? req.category.toLowerCase() : '';
        const id = req.id ? req.id.toUpperCase() : '';
        return category.includes(colType) ||
               category.includes(colName) ||
               id.startsWith(colIdPrefix);
      });

      if (rows.length === 0 || cols.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">„Éû„Éà„É™„ÉÉ„ÇØ„ÇπË°®Á§∫„Å´ÂøÖË¶Å„Å™Ë¶ÅÊ±Ç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div></div>';
        return;
      }

      // „Éû„Éà„É™„ÉÉ„ÇØ„Çπ„ÉÜ„Éº„Éñ„É´„Çí‰ΩúÊàê
      let html = '<div style="overflow: auto; max-height: 100%;"><table style="border-collapse: collapse; font-size: 12px; width: 100%;">';
      html += '<thead><tr><th style="border: 1px solid var(--border); padding: 8px; background: var(--surface); position: sticky; top: 0; left: 0; z-index: 3;">' + rowName + ' \\ ' + colName + '</th>';

      cols.forEach(col => {
        html += '<th style="border: 1px solid var(--border); padding: 8px; background: var(--surface); min-width: 100px; position: sticky; top: 0; z-index: 2;">' + col.id + '<br><span style="font-weight: normal; font-size: 11px;">' + col.title.substring(0, 20) + '</span></th>';
      });
      html += '</tr></thead><tbody>';

      rows.forEach(row => {
        html += '<tr><td style="border: 1px solid var(--border); padding: 8px; background: var(--surface); font-weight: bold; position: sticky; left: 0; z-index: 1;">' + row.id + '<br><span style="font-weight: normal; font-size: 11px;">' + row.title.substring(0, 30) + '</span></td>';

        cols.forEach(col => {
          // ‰æùÂ≠òÈñ¢‰øÇ„ÉªrefinesÈñ¢‰øÇ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          const hasRelation = (row.dependencies && row.dependencies.includes(col.id)) ||
                             (col.dependencies && col.dependencies.includes(row.id)) ||
                             (row.refines && row.refines.includes(col.id)) ||
                             (col.refines && col.refines.includes(row.id)) ||
                             row.parentId === col.id || col.parentId === row.id;

          const cellStyle = hasRelation ? 'background: var(--primary); opacity: 0.3; cursor: pointer;' : '';
          const cellContent = hasRelation ? '‚óè' : '';
          const dataAttr = hasRelation ? \`data-row-id="$\{row.id}" data-col-id="$\{col.id}" class="matrix-cell"\` : '';
          html += '<td style="border: 1px solid var(--border); padding: 8px; text-align: center; ' + cellStyle + '" ' + dataAttr + '>' + cellContent + '</td>';
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;

      // „Éû„Éà„É™„ÉÉ„ÇØ„Çπ„Çª„É´„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
      document.querySelectorAll('.matrix-cell').forEach(cell => {
        cell.addEventListener('click', async () => {
          const colId = cell.dataset.colId;
          if (colId) {
            await loadAndSelectRequirement(colId);
          }
        });
      });
    }

    // „Éì„É•„ÉºË®≠ÂÆö„ÇíË™≠„ÅøËæº„Çì„Åß„Éì„É•„ÉºÈÅ∏Êäû„É™„Çπ„Éà„ÇíÁîüÊàê
    async function loadViewConfig() {
      try {
        const response = await fetch('/api/view-config');
        const config = await response.json();

        const viewModeSelect = document.getElementById('viewMode');
        viewModeSelect.innerHTML = '';

        config.views.forEach(view => {
          const option = document.createElement('option');
          option.value = view.id;
          option.textContent = view.name;
          if (view.description) {
            option.title = view.description;
          }
          viewModeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('„Éì„É•„ÉºË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
      }
    }

    // „ÉÑ„É™„Éº„Éá„Éº„Çø„ÇíÂèñÂæó
    async function loadTree() {
      try {
        const response = await fetch('/api/tree');
        const data = await response.json();
        renderTree(data.tree);
      } catch (error) {
        console.error('„ÉÑ„É™„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
      }
    }

    // „ÉÑ„É™„Éº„ÇíÊèèÁîªÔºà„Ç∞„É´„Éº„ÉóÂà•Ôºâ
    function renderTree(tree) {
      const container = document.getElementById('treeContainer');
      container.innerHTML = '';

      console.log('Âèó‰ø°„Åó„Åü„ÉÑ„É™„Éº„Éá„Éº„Çø:', tree.length + '‰ª∂');

      // Store all requirements for search
      allRequirements = tree.map(node => node.requirement);

      // ‰ΩúÊàêËÄÖ„É™„Çπ„Éà„ÇíÁîüÊàê
      const authors = new Set();
      allRequirements.forEach(req => {
        if (req.author) {
          authors.add(req.author);
        }
      });
      const authorSelect = document.getElementById('filterAuthor');
      authorSelect.innerHTML = '<option value="">ÂÖ®„Å¶„ÅÆ‰ΩúÊàêËÄÖ</option>';
      Array.from(authors).sort().forEach(author => {
        const option = document.createElement('option');
        option.value = author;
        option.textContent = author;
        authorSelect.appendChild(option);
      });

      // Ë¶ÅÊ±Ç„ÇíÁ®ÆÈ°ûÂà•„Å´„Ç∞„É´„Éº„ÉóÂåñÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
      const groups = {
        stakeholder: { name: '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç', icon: '', color: 'stakeholder', items: [], ids: new Set() },
        system: { name: '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç', icon: '', color: 'system', items: [], ids: new Set() },
        functional: { name: '„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç', icon: '', color: 'functional', items: [], ids: new Set() }
      };

      tree.forEach(node => {
        const req = node.requirement;
        console.log('Âá¶ÁêÜ‰∏≠„ÅÆË¶ÅÊ±Ç:', req.id, req.title);

        // type„Éï„Ç£„Éº„É´„Éâ„ÅÆÊ≠£Ë¶èÂåñ: system_functional -> functional
        let type = req.type;
        if (type === 'system_functional') {
          type = 'functional';
        }

        // type„Éï„Ç£„Éº„É´„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅcategory„ÇÑID„Åã„ÇâÊé®Ê∏¨
        if (!type) {
          if (req.id && req.id.startsWith('STK-')) {
            type = 'stakeholder';
          } else if (req.id && req.id.startsWith('SYS-')) {
            type = 'system';
          } else if (req.id && req.id.startsWith('FUNC-')) {
            type = 'functional';
          } else if (req.category && req.category.includes('„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ')) {
            type = 'stakeholder';
          } else if (req.category && req.category.includes('„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç')) {
            type = 'system';
          } else if (req.category && (req.category.includes('Ê©üËÉΩ') || req.category.includes('„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩ'))) {
            type = 'functional';
          } else {
            type = 'stakeholder'; // „Éá„Éï„Ç©„É´„Éà
          }
        }

        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ: Âêå„ÅòID„Åå„Åô„Åß„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
        if (groups[type]) {
          if (groups[type].ids.has(req.id)) {
            console.warn('ÈáçË§áÊ§úÂá∫:', req.id, '„ÅØ„Åô„Åß„Å´', type, '„Ç∞„É´„Éº„Éó„Å´Â≠òÂú®„Åó„Åæ„Åô');
          } else {
            groups[type].items.push(req);
            groups[type].ids.add(req.id);
            console.log('ËøΩÂä†:', req.id, '„Çí', type, '„Ç∞„É´„Éº„Éó„Å´ËøΩÂä†');
          }
        }
      });

      // „Ç∞„É´„Éº„Éó„Åî„Å®„ÅÆË¶ÅÊ±ÇÊï∞„Çí„É≠„Ç∞Âá∫Âäõ
      console.log('„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç:', groups.stakeholder.items.length);
      console.log('„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç:', groups.system.items.length);
      console.log('„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç:', groups.functional.items.length);

      // „Ç∞„É´„Éº„Éó„Åî„Å®„Å´ÊèèÁîª
      Object.entries(groups).forEach(([typeKey, group]) => {
        if (group.items.length === 0) return;

        // „Ç∞„É´„Éº„Éó„Éò„ÉÉ„ÉÄ„Éº
        const groupHeader = document.createElement('div');
        groupHeader.className = 'tree-group-header';
        groupHeader.innerHTML = \`
          <span class="tree-group-icon">‚ñ∂</span>
          <span class="tree-group-title">\${group.icon} \${group.name}</span>
          <span class="tree-group-count">(\${group.items.length})</span>
        \`;

        const groupContent = document.createElement('div');
        groupContent.className = 'tree-group-content';
        groupContent.style.display = 'block'; // ÂàùÊúüÁä∂ÊÖã„ÅØÂ±ïÈñã

        // „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ„Ç¢„Ç§„ÉÜ„É†
        group.items.forEach(req => {
          const item = document.createElement('div');
          item.className = \`tree-item \${typeKey}\`;
          item.dataset.id = req.id;

          item.innerHTML = \`
            <span class="tree-item-icon">\${group.icon}</span>
            <span class="tree-item-title">\${req.title}</span>
            <span class="tree-item-id">\${req.id}</span>
          \`;

          item.addEventListener('click', (e) => {
            e.stopPropagation();
            selectRequirement(req);
          });
          groupContent.appendChild(item);
        });

        // „Ç∞„É´„Éº„Éó„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ïÈñã„ÉªÊäò„Çä„Åü„Åü„Åø
        groupHeader.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const isCollapsed = groupContent.classList.contains('collapsed');

          if (isCollapsed) {
            // Â±ïÈñã
            groupContent.classList.remove('collapsed');
            groupHeader.querySelector('.tree-group-icon').textContent = '‚ñº';
          } else {
            // Êäò„Çä„Åü„Åü„Åø
            groupContent.classList.add('collapsed');
            groupHeader.querySelector('.tree-group-icon').textContent = '‚ñ∂';
          }
        });

        // ÂàùÊúüÁä∂ÊÖã„ÇíÂ±ïÈñãÔºà‚ñºÔºâ„Å´„Åô„Çã
        groupHeader.querySelector('.tree-group-icon').textContent = '‚ñº';

        container.appendChild(groupHeader);
        container.appendChild(groupContent);
      });
    }

    // Ë¶ÅÊ±Ç„ÇíÈÅ∏Êäû
    function selectRequirement(req) {
      selectedRequirement = req;

      // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      document.querySelectorAll('.tree-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.id === req.id);
      });

      // Ë©≥Á¥∞„ÇíË°®Á§∫
      renderDetail(req);
    }

    // Ë©≥Á¥∞„ÇíÊèèÁîª
    async function renderDetail(req) {
      const header = document.getElementById('detailHeader');
      const body = document.getElementById('detailBody');

      // „Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„Å´„É™„Çª„ÉÉ„Éà
      body.style.display = 'grid';

      const type = req.type || 'stakeholder';
      const typeLabel = type === 'stakeholder' ? '„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄË¶ÅÊ±Ç' :
                        type === 'system' ? '„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç' :
                        (type === 'system_functional' || type === 'functional') ? '„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç' : '„Ç∑„Çπ„ÉÜ„É†Ê©üËÉΩË¶ÅÊ±Ç';

      header.innerHTML = \`
        <h2>\${req.id}„ÄÄ\${req.title}</h2>
      \`;

      // ‰∏ä‰Ωç„Éª‰∏ã‰ΩçË¶ÅÊ±Ç„ÇíÂèñÂæó
      let relations = { parents: [], children: [] };
      try {
        const relResponse = await fetch(\`/api/requirement/\${req.id}/relations\`);
        relations = await relResponse.json();
      } catch (error) {
        console.error('Èñ¢ÈÄ£Ë¶ÅÊ±Ç„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
      }

      // ‰∏ä‰ΩçË¶ÅÊ±Ç„ÅÆHTMLÁîüÊàê
      const parentsHtml = relations.parents.length > 0 ? \`
        <div class="detail-section">
          <h3>‚ñ≤ ‰∏ä‰ΩçË¶ÅÊ±Ç</h3>
          $\{relations.parents.map(parent => \`
            <div class="relation-link" data-req-id="$\{parent.id}">
              <span class="relation-link-icon">$\{getTypeIcon(parent.type || parent.category)}</span>
              <div class="relation-link-content">
                <div class="relation-link-id">$\{parent.id}</div>
                <div class="relation-link-title">$\{parent.title}</div>
                <div class="relation-link-meta">
                  <span class="relation-link-badge">$\{parent.status}</span>
                  <span class="relation-link-badge">$\{parent.priority}</span>
                </div>
              </div>
            </div>
          \`).join('')}
        </div>
      \` : '';

      // ‰∏ã‰ΩçË¶ÅÊ±Ç„ÅÆHTMLÁîüÊàê
      const childrenHtml = relations.children.length > 0 ? \`
        <div class="detail-section">
          <h3>‚ñº ‰∏ã‰ΩçË¶ÅÊ±Ç</h3>
          $\{relations.children.map(child => \`
            <div class="relation-link" data-req-id="$\{child.id}">
              <span class="relation-link-icon">$\{getTypeIcon(child.type || child.category)}</span>
              <div class="relation-link-content">
                <div class="relation-link-id">$\{child.id}</div>
                <div class="relation-link-title">$\{child.title}</div>
                <div class="relation-link-meta">
                  <span class="relation-link-badge">$\{child.status}</span>
                  <span class="relation-link-badge">$\{child.priority}</span>
                </div>
              </div>
            </div>
          \`).join('')}
        </div>
      \` : '';

      body.innerHTML = \`
        <div class="detail-columns">
          <div class="detail-column-left">
            <div class="detail-section">
              <h3>Ë™¨Êòé</h3>
              <div class="detail-field-value">$\{req.description}</div>
            </div>

            $\{req.rationale ? \`
            <div class="detail-section">
              <h3>ÁêÜÁî±</h3>
              <div class="detail-field-value">$\{req.rationale}</div>
            </div>
            \` : ''}

            <div class="detail-section">
              <h3>Âü∫Êú¨ÊÉÖÂ†±</h3>
              <div class="detail-field">
                <div class="detail-field-label">‰ΩúÊàêÊó•</div>
                <div class="detail-field-value">$\{new Date(req.createdAt).toLocaleDateString('ja-JP')}</div>
              </div>
              <div class="detail-field">
                <div class="detail-field-label">Êõ¥Êñ∞Êó•</div>
                <div class="detail-field-value">$\{new Date(req.updatedAt).toLocaleDateString('ja-JP')}</div>
              </div>
              <div class="detail-field">
                <div class="detail-field-label">„Ç´„ÉÜ„Ç¥„É™</div>
                <div class="detail-field-value">$\{req.category}</div>
              </div>
              <div class="detail-field">
                <div class="detail-field-label">ÂÑ™ÂÖàÂ∫¶</div>
                <div class="detail-field-value">
                  <span class="badge badge-priority-$\{req.priority}">$\{req.priority.toUpperCase()}</span>
                </div>
              </div>
              <div class="detail-field">
                <div class="detail-field-label">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                <div class="detail-field-value">
                  <span class="badge badge-status">$\{req.status}</span>
                </div>
              </div>
              $\{req.author ? \`
              <div class="detail-field">
                <div class="detail-field-label">‰ΩúÊàêËÄÖ</div>
                <div class="detail-field-value">$\{req.author}</div>
              </div>
              \` : ''}
              $\{req.assignee ? \`
              <div class="detail-field">
                <div class="detail-field-label">ÊãÖÂΩìËÄÖ</div>
                <div class="detail-field-value">$\{req.assignee}</div>
              </div>
              \` : ''}
            </div>

            $\{req.tags && req.tags.length > 0 ? \`
            <div class="detail-section">
              <h3>„Çø„Ç∞</h3>
              <div class="tag-list">
                $\{req.tags.map(tag => \`<span class="tag">$\{tag}</span>\`).join('')}
              </div>
            </div>
            \` : ''}
          </div>

          <div class="detail-column-right">
            $\{(parentsHtml || childrenHtml) ? \`
            <div class="relations-grid">
              $\{parentsHtml || '<div></div>'}
              $\{childrenHtml || '<div></div>'}
            </div>
            \` : ''}
          </div>
        </div>
      \`;

      // Èñ¢ÈÄ£Ë¶ÅÊ±Ç„É™„É≥„ÇØ„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
      document.querySelectorAll('.relation-link').forEach(link => {
        link.addEventListener('click', async () => {
          const reqId = link.dataset.reqId;
          await loadAndSelectRequirement(reqId);
        });
      });
    }

    // Ë¶ÅÊ±Ç„Çø„Ç§„Éó„Åã„Çâ„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
    function getTypeIcon(type) {
      if (type === 'stakeholder' || (type && type.includes('„Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ'))) {
        return '‚óè';
      } else if (type === 'system' || (type && type.includes('„Ç∑„Çπ„ÉÜ„É†Ë¶ÅÊ±Ç'))) {
        return '‚ñ†';
      } else if (type === 'functional' || type === 'system_functional' || (type && type.includes('Ê©üËÉΩ'))) {
        return '‚ñ≤';
      }
      return '‚óã';
    }

    // Ë¶ÅÊ±ÇID„Åã„ÇâË¶ÅÊ±Ç„ÇíË™≠„ÅøËæº„Çì„ÅßÈÅ∏Êäû
    async function loadAndSelectRequirement(reqId) {
      try {
        const response = await fetch('/api/tree');
        const data = await response.json();

        const targetNode = data.tree.find(node => node.requirement.id === reqId);
        if (targetNode) {
          selectRequirement(targetNode.requirement);
        }
      } catch (error) {
        console.error('Ë¶ÅÊ±Ç„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
      }
    }

    // ÂàùÊúüÂåñ
    loadViewConfig();
    loadTree();

    // Ëá™ÂãïÊõ¥Êñ∞Ôºà5Áßí„Åî„Å®Ôºâ
    setInterval(loadTree, 5000);

    // „ÉÅ„É£„ÉÉ„Éà„Éë„Éç„É´„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
    const chatPanel = document.getElementById('chatPanel');
    const chatResizer = document.getElementById('chatResizer');
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    chatResizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.clientX;
      startWidth = chatPanel.offsetWidth;
      chatResizer.classList.add('resizing');
      document.body.style.cursor = 'ew-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;

      const diff = startX - e.clientX;
      const newWidth = startWidth + diff;

      // ÊúÄÂ∞è„ÉªÊúÄÂ§ßÂπÖ„ÇíÂà∂Èôê
      if (newWidth >= 300 && newWidth <= 800) {
        chatPanel.style.width = newWidth + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        chatResizer.classList.remove('resizing');
        document.body.style.cursor = '';
      }
    });

    // Search„Éë„Éç„É´„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
    const searchPanel = document.getElementById('searchPanel');
    const searchResizer = document.getElementById('searchResizer');
    let isResizingSearch = false;
    let startY = 0;
    let startHeight = 0;

    searchResizer.addEventListener('mousedown', (e) => {
      isResizingSearch = true;
      startY = e.clientY;
      startHeight = searchPanel.offsetHeight;
      document.body.style.cursor = 'ns-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizingSearch) return;

      // „Éû„Ç¶„Çπ„Çí‰∏ä„Å´Âãï„Åã„Åô„Å®È´ò„Åï„ÅåÊ∏õ„ÇãÔºàÂ¢ÉÁïåÁ∑ö„Åå‰∏ä„Åå„ÇãÔºâ
      const diff = startY - e.clientY;
      const newHeight = startHeight + diff;

      // ÊúÄÂ∞è„ÉªÊúÄÂ§ßÈ´ò„Åï„ÇíÂà∂Èôê
      if (newHeight >= 200 && newHeight <= 800) {
        searchPanel.style.height = newHeight + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizingSearch) {
        isResizingSearch = false;
        document.body.style.cursor = '';
      }
    });

    // „ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatMessages = document.getElementById('chatMessages');

    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar' + (isUser ? ' user' : '');
      avatarDiv.textContent = isUser ? 'Y' : 'C';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';

      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';
      textDiv.textContent = text;

      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

      contentDiv.appendChild(textDiv);
      contentDiv.appendChild(timeDiv);
      messageDiv.appendChild(avatarDiv);
      messageDiv.appendChild(contentDiv);

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'chat-message';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = \`
        <div class="message-avatar">C</div>
        <div class="message-content">
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      \`;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
      addMessage(message, true);
      chatInput.value = '';
      chatInput.style.height = '44px';
      chatSend.disabled = true;

      // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
      showTyping();

      try {
        // API„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å´ÈÄÅ‰ø°
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await response.json();
        hideTyping();
        addMessage(data.response, false);
      } catch (error) {
        hideTyping();
        addMessage('Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', false);
        console.error('Chat error:', error);
      } finally {
        chatSend.disabled = false;
      }
    }

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆËá™Âãï„Çµ„Ç§„Ç∫Ë™øÊï¥
    chatInput.addEventListener('input', () => {
      chatInput.style.height = '44px';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });
  </script>
    </div>
    </div>
  </div>

  <!-- „Éì„É•„Éº‰∏ÄË¶ß„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
  <div class="tab-content" id="views-content">
    <div style="flex: 1; overflow-y: auto; padding: 40px;">
      <div style="max-width: 1200px; margin: 0 auto;">
        <h1 style="font-size: 32px; margin-bottom: 8px;">üìä Ë¶ÅÊ±ÇÁÆ°ÁêÜ„Éì„É•„Éº„Ç¢„Éº</h1>
        <p style="color: var(--text-secondary); margin-bottom: 40px;">
          9Á®ÆÈ°û„ÅÆ„Éì„É•„Éº„ÅßË¶ÅÊ±Ç„ÇíÂèØË¶ñÂåñ„ÉªÁÆ°ÁêÜ
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
          <a href="/list" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üìã</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">‰∏ÄË¶ß„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">ÂÖ®Ë¶ÅÊ±Ç„Çí„ÉÜ„Éº„Éñ„É´ÂΩ¢Âºè„ÅßË°®Á§∫</p>
            </div>
          </a>

          <a href="/status" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üìä</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">„Çπ„ÉÜ„Éº„Çø„Çπ„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">„Çπ„ÉÜ„Éº„Çø„ÇπÂà•„Å´Ë¶ÅÊ±Ç„ÇíÂàÜÈ°û</p>
            </div>
          </a>

          <a href="/priority" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üéØ</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">ÂÑ™ÂÖàÂ∫¶„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">ÂÑ™ÂÖàÂ∫¶Âà•„Å´Ë¶ÅÊ±Ç„ÇíÂàÜÈ°û</p>
            </div>
          </a>

          <a href="/category" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üìë</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">„Ç´„ÉÜ„Ç¥„É™„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">„Ç´„ÉÜ„Ç¥„É™Âà•„Å´Ë¶ÅÊ±Ç„ÇíÂàÜÈ°û</p>
            </div>
          </a>

          <a href="/timeline" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üìÖ</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">„Çø„Ç§„É†„É©„Ç§„É≥„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">ÊôÇÁ≥ªÂàó„ÅßË¶ÅÊ±Ç„ÇíË°®Á§∫</p>
            </div>
          </a>

          <a href="/dependency" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üîó</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">‰æùÂ≠òÈñ¢‰øÇ„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">Ë¶ÅÊ±ÇÈñì„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÂèØË¶ñÂåñ</p>
            </div>
          </a>

          <a href="/tags" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üè∑Ô∏è</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">„Çø„Ç∞„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">„Çø„Ç∞Âà•„Å´Ë¶ÅÊ±Ç„ÇíÂàÜÈ°û</p>
            </div>
          </a>

          <a href="/search" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üîç</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">Ê§úÁ¥¢„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">Ë¶ÅÊ±Ç„ÇíÊ§úÁ¥¢„Éª„Éï„Ç£„É´„Çø</p>
            </div>
          </a>

          <a href="/stats" style="text-decoration: none; color: inherit;">
            <div style="background: var(--surface); padding: 24px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.2s ease; cursor: pointer;">
              <div style="font-size: 32px; margin-bottom: 12px;">üìà</div>
              <h3 style="font-size: 18px; margin-bottom: 8px;">Áµ±Ë®à„Éì„É•„Éº</h3>
              <p style="color: var(--text-secondary); font-size: 14px;">Ë¶ÅÊ±Ç„ÅÆÁµ±Ë®àÊÉÖÂ†±„ÇíË°®Á§∫</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.dataset.tab;

        // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åã„Çâ active „ÇØ„É©„Çπ„ÇíÂâäÈô§
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Éú„Çø„É≥„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å´ active „ÇØ„É©„Çπ„ÇíËøΩÂä†
        button.classList.add('active');
        document.getElementById(tabName + '-content').classList.add('active');
      });
    });
  </script>
</body>
</html>
  `;

  res.send(html);
});

// ÊóßUI„Éö„Éº„Ç∏ÔºàÂâäÈô§‰∫àÂÆöÔºâ
app.get('/old', (req, res) => {
  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ë¶ÅÊ±ÇÁÆ°ÁêÜ„Éì„É•„Éº„Ç¢„Éº</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #475569;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* „Çµ„Ç§„Éâ„Éê„Éº */
    .sidebar {
      width: 320px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: white;
    }

    .sidebar-header p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .project-selector {
      margin-top: 16px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .project-selector-label {
      font-size: 12px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 6px;
      display: block;
    }

    .project-selector select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .project-selector select:hover {
      border-color: rgba(255, 255, 255, 0.4);
    }

    .project-selector select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2);
    }

    .project-badge {
      display: inline-block;
      margin-top: 6px;
      padding: 4px 8px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: rgba(34, 197, 94, 1);
    }

    .view-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .view-button {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 8px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .view-button:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .view-button.active {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .view-button .icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .view-button .name {
      flex: 1;
      font-weight: 500;
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-header {
      padding: 20px 32px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .content-header h2 {
      font-size: 24px;
      font-weight: 600;
    }

    .refresh-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--success);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .refresh-indicator.show {
      opacity: 1;
    }

    .content-body {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    /* Markdown styling */
    .markdown-content {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--surface);
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .markdown-content h1 {
      font-size: 32px;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .markdown-content h2 {
      font-size: 24px;
      margin-top: 32px;
      margin-bottom: 16px;
      color: var(--text);
    }

    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0;
      font-size: 14px;
    }

    .markdown-content th {
      background: var(--surface-light);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .markdown-content td {
      padding: 12px;
      border: 1px solid var(--border);
    }

    .markdown-content tr:hover {
      background: var(--surface-light);
    }

    .markdown-content p {
      margin: 16px 0;
      color: var(--text-secondary);
    }

    .markdown-content hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 32px 0;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 18px;
      color: var(--text-secondary);
    }

    .error {
      padding: 32px;
      text-align: center;
      color: var(--danger);
    }

    /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--surface-light);
      border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üìã Ë¶ÅÊ±ÇÁÆ°ÁêÜ„Éì„É•„Éº„Ç¢„Éº</h1>
        <p>„É™„Ç¢„É´„Çø„Ç§„É†Ëá™ÂãïÊõ¥Êñ∞</p>

        <div class="project-selector">
          <label class="project-selector-label">üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„Éà</label>
          <select id="projectSelect">
            <option value="">Ë™≠„ÅøËæº„Åø‰∏≠...</option>
          </select>
          <span class="project-badge" id="projectBadge">ÁèæÂú®: --</span>
        </div>
      </div>
      <div class="view-list" id="viewList"></div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="main-content">
      <div class="content-header">
        <h2 id="currentViewName">„Éì„É•„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
        <div class="refresh-indicator" id="refreshIndicator">
          <span>‚úì</span>
          <span>Êõ¥Êñ∞„Åó„Åæ„Åó„Åü</span>
        </div>
      </div>
      <div class="content-body">
        <div id="content" class="loading">
          „Éì„É•„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        </div>
      </div>
    </div>
  </div>

  <script>
    const views = ${JSON.stringify(VIEWS)};
    let currentView = null;
    let lastModified = {};
    let eventSource = null;
    let currentProject = null;

    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
    async function loadProjects() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();

        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '';

        data.projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.projectId;
          const displayName = project.systemName
            ? \`\${project.systemName} - \${project.projectName} (\${project.requirementCount}‰ª∂)\`
            : \`\${project.projectName} (\${project.requirementCount}‰ª∂)\`;
          option.textContent = displayName;
          if (project.isCurrent) {
            option.selected = true;
            currentProject = project;
            updateProjectBadge(project);
          }
          projectSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load projects:', error);
      }
    }

    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
    function updateProjectBadge(project) {
      const badge = document.getElementById('projectBadge');
      const displayText = project.systemName
        ? \`ÁèæÂú®: \${project.systemName} - \${project.projectName}\`
        : \`ÁèæÂú®: \${project.projectName}\`;
      badge.textContent = displayText;
    }

    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà
    async function switchProject(projectId) {
      if (!projectId || (currentProject && projectId === currentProject.projectId)) {
        return;
      }

      try {
        const response = await fetch('/api/project/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId })
        });

        const data = await response.json();

        if (data.success) {
          currentProject = data.project;
          updateProjectBadge(data.project);

          // ÁèæÂú®„ÅÆ„Éì„É•„Éº„Çí„É™„É≠„Éº„Éâ
          if (currentView) {
            await loadView(currentView);
          }

          showRefreshIndicator();
        } else {
          alert(\`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂàá„ÇäÊõø„Åà„Ç®„É©„Éº: \${data.error}\`);
        }
      } catch (error) {
        console.error('Failed to switch project:', error);
        alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }

    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çª„É¨„ÇØ„Éà„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    document.getElementById('projectSelect').addEventListener('change', (e) => {
      switchProject(e.target.value);
    });

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÂèñÂæó
    loadProjects();

    // „Éì„É•„Éº„Éú„Çø„É≥„ÇíÁîüÊàê
    const viewList = document.getElementById('viewList');
    views.forEach(view => {
      const button = document.createElement('button');
      button.className = 'view-button';
      button.innerHTML = \`
        <span class="icon">\${view.icon}</span>
        <span class="name">\${view.name}</span>
      \`;
      button.addEventListener('click', () => loadView(view));
      viewList.appendChild(button);
    });

    // „Éì„É•„Éº„ÇíË™≠„ÅøËæº„Åø
    async function loadView(view) {
      currentView = view;

      // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      document.querySelectorAll('.view-button').forEach((btn, idx) => {
        btn.classList.toggle('active', views[idx].id === view.id);
      });

      document.getElementById('currentViewName').textContent = view.name;
      document.getElementById('content').innerHTML = '<div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

      try {
        if (view.id === 'operation-logs') {
          const logResponse = await fetch('/api/operation-logs-data');
          const logData = await logResponse.json();
          
          let html = '<h1>üîç Êìç‰ΩúÂ±•Ê≠¥</h1><p>„Åæ„Å†Êìç‰ΩúÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
          
          if (logData.logs && logData.logs.length > 0) {
            html = '<h1>üîç Êìç‰ΩúÂ±•Ê≠¥Ôºà„Éá„Éê„ÉÉ„Ç∞Ôºâ</h1><h2>Áµ±Ë®à: ' + logData.stats.totalOperations + ' ‰ª∂</h2>';
            logData.logs.forEach(log => {
              html += '<div style="border:1px solid #475569; padding:16px; margin:16px 0"><h3>' + log.operation + '</h3><p>„ÉÑ„Éº„É´: ' + log.toolName + '</p><details><summary>Ë©≥Á¥∞</summary><pre>' + JSON.stringify(log.parameters, null, 2) + '</pre></details></div>';
            });
          }
          
          document.getElementById('content').innerHTML = '<div class="markdown-content">' + html + '</div>';
          return;
        }
        const response = await fetch(\`/api/view/\${view.id}\`);
        const data = await response.json();

        if (data.error) {
          document.getElementById('content').innerHTML = \`<div class="error">\${data.error}</div>\`;
          return;
        }

        document.getElementById('content').innerHTML = \`<div class="markdown-content">\${data.html}</div>\`;
        lastModified[view.id] = data.lastModified;
      } catch (error) {
        document.getElementById('content').innerHTML = \`<div class="error">„Ç®„É©„Éº: \${error.message}</div>\`;
      }
    }

    // SSE„ÅßËá™ÂãïÊõ¥Êñ∞„ÇíÁõ£Ë¶ñ
    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/api/watch');

      eventSource.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (currentView && data.changed) {
          // ÁèæÂú®„ÅÆ„Éì„É•„Éº„ÅåÊõ¥Êñ∞„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          const shouldReload = data.changed.some(file =>
            file.includes(currentView.id)
          );

          if (shouldReload) {
            console.log('„Éì„É•„Éº„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô...');
            await loadView(currentView);

            // Êõ¥Êñ∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÇíË°®Á§∫
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
              indicator.classList.remove('show');
            }, 2000);
          }
        }
      };

      eventSource.onerror = () => {
        console.error('SSEÊé•Á∂ö„Ç®„É©„Éº„ÄÇÂÜçÊé•Á∂ö„Åó„Åæ„Åô...');
        setTimeout(connectSSE, 3000);
      };
    }

    // ÂàùÊúüÂåñ
    connectSSE();

    // ÊúÄÂàù„ÅÆ„Éì„É•„Éº„ÇíËá™ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
    if (views.length > 0) {
      loadView(views[0]);
    }
  </script>
</body>
</html>
  `;

  res.send(html);
});

// „Éì„É•„Éº„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂèñÂæó
app.get('/api/view/:viewId', async (req, res) => {
  const { viewId } = req.params;

  try {
    const mdPath = path.join(process.cwd(), 'views', 'markdown', `${viewId}.md`);
    const content = await fs.readFile(mdPath, 'utf-8');
    const html = marked(content);
    const stats = await fs.stat(mdPath);

    res.json({
      html,
      lastModified: stats.mtimeMs,
    });
  } catch (error: any) {
    res.json({
      error: `„Éì„É•„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`,
    });
  }
});

// SSE (Server-Sent Events) „Åß„Éï„Ç°„Ç§„É´Â§âÊõ¥„ÇíÁõ£Ë¶ñ
app.get('/api/watch', (req, res) => {
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');

  const viewsDir = path.join(process.cwd(), 'views', 'markdown');

  // chokidar„Åß„Éï„Ç°„Ç§„É´Â§âÊõ¥„ÇíÁõ£Ë¶ñ
  const watcher = chokidar.watch(viewsDir, {
    ignoreInitial: true,
    awaitWriteFinish: {
      stabilityThreshold: 200,
      pollInterval: 100,
    },
  });

  watcher.on('change', (filePath) => {
    const changed = [path.basename(filePath, '.md')];
    res.write(`data: ${JSON.stringify({ changed })}\n\n`);
  });

  // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÊé•Á∂ö„ÇíÂàá„Å£„ÅüÊôÇ„Å´watcher„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
  req.on('close', () => {
    watcher.close();
    res.end();
  });
});

// „ÉÅ„É£„ÉÉ„ÉàAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà - Enhanced Chat Assistant (OrchestratorÁµ±ÂêàÁâà)
app.post('/api/chat', express.json(), async (req, res) => {
  try {
    const { message } = req.body;

    if (!message || message.trim() === '') {
      return res.status(400).json({
        response: '‚ùå „É°„ÉÉ„Çª„Éº„Ç∏„ÅåÁ©∫„Åß„Åô„ÄÇË≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
      });
    }

    // MCP Chat Assistant (highest priority)
    if (mcpChatReady && mcpChatAssistant && mcpChatAssistant.isAvailable()) {
      console.log('[Chat] Using MCP Chat Assistant');
      const response = await mcpChatAssistant.chat(message);
      res.json({ response });
    } else if (enhancedChatReady && enhancedChatAssistant.isAvailable()) {
      console.log('[Chat] Using Enhanced Chat Assistant (Orchestrator)');
      const response = await enhancedChatAssistant.chat(message);
      res.json({ response });
    } else {
      // Fallback to basic chat assistant
      console.log('[Chat] Fallback to Basic Chat Assistant');
      const assistant = await ensureChatAssistantReady();
      const response = await assistant.chat(message);
      res.json({ response });
    }
  } catch (error: any) {
    console.error('Chat API error:', error);
    res.status(500).json({
      response: `‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:\n\n${error.message}\n\n„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`
    });
  }
});

// ‰ºöË©±Â±•Ê≠¥„ÇØ„É™„Ç¢„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.post('/api/chat/clear', express.json(), async (req, res) => {
  try {
    const assistant = await ensureChatAssistantReady();
    assistant.clearHistory();
    res.json({ success: true, message: '‰ºöË©±Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ' });
  } catch (error: any) {
    console.error('Chat clear error:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// AIÂà©Áî®ÂèØËÉΩÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/chat/status', async (req, res) => {
  try {
    const assistant = await ensureChatAssistantReady();
    const isAvailable = assistant.isAvailable();
    res.json({
      aiEnabled: isAvailable,
      message: isAvailable
        ? 'AI„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„ÅåÊúâÂäπ„Åß„Åô'
        : 'AI„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ ANTHROPIC_API_KEY „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
    });
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

// „ÉÑ„É™„Éº„Éì„É•„ÉºAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/tree', async (req, res) => {
  try {
    await storage.initialize();
    const requirements = await storage.getAllRequirements();

    // ÂÖ®„Å¶„ÅÆË¶ÅÊ±Ç„ÇíÂÆåÂÖ®„Å´„Éï„É©„ÉÉ„Éà„Å´Ëøî„Åô
    // ÈáçË§á„ÇíÊéíÈô§„Åô„Çã„Åü„ÇÅ„Å´„ÄÅID„Åß„É¶„Éã„Éº„ÇØ„Å´„Åô„Çã
    const uniqueRequirements = Array.from(
      new Map(requirements.map(req => [req.id, req])).values()
    );

    const flatTree = uniqueRequirements.map(req => ({
      requirement: req,
      children: [],
      level: 0,
      indent: 0
    }));

    res.json({
      tree: flatTree,
      count: flatTree.length,
    });
  } catch (error: any) {
    res.json({
      error: error.message,
      tree: [],
      count: 0,
    });
  }
});

// „Éì„É•„ÉºË®≠ÂÆö„ÇíÂèñÂæó„Åô„ÇãAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/view-config', async (req, res) => {
  try {
    const fs = await import('fs/promises');
    const path = await import('path');
    const configPath = path.join(process.cwd(), 'view-config.json');

    try {
      const configData = await fs.readFile(configPath, 'utf-8');
      const config = JSON.parse(configData);
      res.json(config);
    } catch (error) {
      // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö„ÇíËøî„Åô
      res.json({
        views: [
          { id: 'list', name: '„É™„Çπ„Éà', type: 'list' },
          { id: 'matrix-stakeholder-system', name: '„Éû„Éà„É™„ÉÉ„ÇØ„Çπ: „Çπ„ÉÜ„Éº„ÇØ„Éõ„É´„ÉÄ‚Üí„Ç∑„Çπ„ÉÜ„É†', type: 'matrix' },
          { id: 'matrix-system-functional', name: '„Éû„Éà„É™„ÉÉ„ÇØ„Çπ: „Ç∑„Çπ„ÉÜ„É†‚ÜíÊ©üËÉΩ', type: 'matrix' }
        ]
      });
    }
  } catch (error: any) {
    res.json({
      error: error.message,
      views: [
        { id: 'list', name: '„É™„Çπ„Éà', type: 'list' }
      ]
    });
  }
});

// Ë¶ÅÊ±Ç„ÅÆ‰∏ä‰Ωç„Éª‰∏ã‰ΩçÈñ¢‰øÇ„ÇíÂèñÂæó„Åô„ÇãAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/requirement/:id/relations', async (req, res) => {
  try {
    await storage.initialize();
    const { id } = req.params;
    const requirement = await storage.getRequirement(id);

    if (!requirement) {
      return res.json({ error: 'Ë¶ÅÊ±Ç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', parents: [], children: [] });
    }

    const allRequirements = await storage.getAllRequirements();

    // ‰∏ä‰ΩçË¶ÅÊ±Ç„ÇíÂèñÂæóÔºà„Åì„ÅÆË¶ÅÊ±Ç„Åårefines„Å´Âê´„ÇÄ„ÇÇ„ÅÆÔºâ
    const refines = requirement.refines || [];
    const parents = allRequirements.filter(r => refines.includes(r.id));

    // ‰∏ã‰ΩçË¶ÅÊ±Ç„ÇíÂèñÂæóÔºà„Åì„ÅÆË¶ÅÊ±Ç„Çírefines„Å´Âê´„ÇÄ„ÇÇ„ÅÆÔºâ
    const children = allRequirements.filter(r => {
      const rRefines = r.refines || [];
      return rRefines.includes(id);
    });

    return res.json({
      parents: parents.map(r => ({
        id: r.id,
        title: r.title,
        type: r.type,
        category: r.category,
        status: r.status,
        priority: r.priority
      })),
      children: children.map(r => ({
        id: r.id,
        title: r.title,
        type: r.type,
        category: r.category,
        status: r.status,
        priority: r.priority
      }))
    });
  } catch (error: any) {
    console.error('[ERROR] /api/requirement/:id/relations:', error);
    return res.json({ error: error.message, parents: [], children: [] });
  }
});

// „Çµ„Éº„Éê„ÉºËµ∑Âãï

// Êìç‰Ωú„É≠„Ç∞API„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/operation-logs-data', async (req, res) => {
  try {
    const logger = new OperationLogger('./data');
    await logger.initialize();

    const logs = logger.getAllLogs();
    const stats = logger.getStatistics();

    res.json({ logs, stats });
  } catch (error: any) {
    res.json({ error: error.message, logs: [], stats: {} });
  }
});

// „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
app.get('/api/projects', async (req, res) => {
  try {
    const projectManager = storage.getProjectManager();
    const projects = await projectManager.listProjects();
    res.json({ projects });
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/project/current', async (req, res) => {
  try {
    const projectManager = storage.getProjectManager();
    const project = await projectManager.getCurrentProject();
    res.json(project);
  } catch (error: any) {
    res.status(500).json({ error: error.message });
  }
});

app.post('/api/project/switch', express.json(), async (req, res) => {
  try {
    const { projectId } = req.body;
    if (!projectId) {
      return res.status(400).json({ error: 'projectId is required' });
    }

    const projectManager = storage.getProjectManager();
    const project = await projectManager.switchProject(projectId);

    // „Çπ„Éà„É¨„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ
    await storage.initialize();

    res.json({
      success: true,
      project,
      message: `„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Äå${project.projectName}„Äç„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`
    });
  } catch (error: any) {
    res.status(500).json({ error: error.message, success: false });
  }
});

app.listen(PORT, () => {
  console.log(`\n========================================`);
  console.log(`üåê Ë¶ÅÊ±ÇÁÆ°ÁêÜ„Éì„É•„Éº„Ç¢„Éº„ÇíËµ∑Âãï„Åó„Åæ„Åó„Åü`);
  console.log(`========================================`);
  console.log(`\nüìç „Ç¢„ÇØ„Çª„ÇπURL: http://localhost:${PORT}`);
  console.log(`\n‚ú® Ê©üËÉΩ:`);
  console.log(`   - ${VIEWS.length}Á®ÆÈ°û„ÅÆ„Éì„É•„Éº„Çí„Éñ„É©„Ç¶„Ç∂„ÅßË°®Á§∫`);
  console.log(`   - „Éï„Ç°„Ç§„É´Â§âÊõ¥ÊôÇ„ÅÆËá™Âãï„É™„Éï„É¨„ÉÉ„Ç∑„É•`);
  console.log(`   - „É¢„ÉÄ„É≥„Å™„ÉÄ„Éº„ÇØ„ÉÜ„Éº„ÉûUI\n`);
  console.log(`ÁµÇ‰∫Ü„Åô„Çã„Å´„ÅØ Ctrl+C „ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n`);
});
