# CLI依存箇所の記録と改善ログ

**最終更新**: 2025-11-08

このドキュメントは、MCPサーバーの機能開発において、CLIスクリプトに依存していた箇所を記録し、今後の改善のための参照資料とします。

---

## 概要

MCPサーバーは本来、MCPツールを通じてすべての機能にアクセスできるべきですが、開発初期段階では一部の機能がCLIスクリプトに依存していました。このドキュメントでは、そのような依存を発見した際に記録し、改善の進捗を追跡します。

---

## 改善済み

### 1. 検証結果の詳細取得（2025-11-08）

**問題**:
検証結果の詳細を取得するために、CLIスクリプト `scripts/detailed-violations.ts` を実行する必要があった。

**発見時の状況**:
- MCPサーバーには `get_validation_report` ツールが存在していた
- しかし、重要度別フィルタリングや構造化されたデータ取得には対応していなかった
- 詳細な違反情報を取得するには、tsxを使ってスクリプトを直接実行する必要があった

**CLI依存コマンドの例**:
```bash
npx tsx scripts/detailed-violations.ts aircon-project
```

**問題点**:
1. MCPツールの範囲外でCLIに頼る必要がある
2. スクリプト実行にはビルド環境やモジュール解決の問題がある
3. Claude Codeとのシームレスな統合ができない
4. 結果のフィルタリングや加工が困難

**解決策**:
新しいMCPツール `get_validation_results` を実装

**実装内容**:
- **ファイル**: `src/index.ts`
- **追加コード**:
  - Zodスキーマ: `GetValidationResultsSchema` (112-116行目)
  - ツール定義: `get_validation_results` (456-467行目)
  - ハンドラー: `handleGetValidationResults` (1037-1160行目)
  - ケース処理: case 'get_validation_results' (254-255行目)

**機能**:
1. キャッシュされた検証結果の取得（未実行時は自動検証）
2. 重要度別フィルタリング（error/warning/info/all）
3. 詳細/簡略モードの切り替え
4. 構造化されたJSON形式での出力
5. ドメイン別・ルール別の統計情報

**影響**:
- CLIスクリプトへの依存を完全に排除
- MCPツールのみで完結する検証ワークフローを実現
- 23個目のMCPツールとして追加
- ドキュメント更新: `docs/user-guide/mcp-tools.md`

**教訓**:
- 既存のツールが存在しても、ユースケースに合わせた新しいツールの追加が必要な場合がある
- CLIスクリプトで提供されている機能は、できる限りMCPツールとして公開すべき
- 構造化されたデータ出力は、プログラマブルな統合に不可欠

---

## 未解決

現在、CLI依存が確認されている箇所はありません。

今後、以下のような状況でCLI依存が発見された場合、このセクションに記録してください：

- MCPツールで提供されていない機能がCLIスクリプトで実装されている
- 特定の操作を行うためにBashコマンドやnpmスクリプトの直接実行が必要
- デバッグやテストのために、MCPサーバーを経由せず直接ファイルを読む必要がある

---

## 改善ガイドライン

CLI依存を発見した場合、以下の手順で改善を検討してください：

### 1. 記録

- 問題の説明（何ができないか、なぜCLIが必要か）
- CLI依存コマンドの例
- 発見日時
- 影響範囲（ユーザー体験、開発効率など）

### 2. 優先度評価

以下の基準で優先度を判断：

- **高**: ユーザーが頻繁に必要とする機能
- **中**: 開発時やデバッグ時に便利だが、回避策がある機能
- **低**: 稀にしか使わない、またはMCPツールの組み合わせで実現可能な機能

### 3. 実装計画

- MCPツールとして実装すべきか
- 既存ツールの拡張で対応可能か
- 新しいエンドポイントの追加が必要か

### 4. ドキュメント更新

- `docs/user-guide/mcp-tools.md` への追加
- 使用例の記載
- 関連ツールとの連携方法

### 5. 完了後

- 「改善済み」セクションに移動
- 実装内容、影響、教訓を記録

---

## 参考資料

- [MCPツール完全ガイド](../user-guide/mcp-tools.md)
- [ツール管理ガイド](tool-management.md)
- [AI支援作業ガイドライン](../AI-WORKFLOW-GUIDELINES.md)

---

## 更新履歴

| 日付 | 内容 | 担当者 |
|------|------|--------|
| 2025-11-08 | 初版作成、get_validation_results実装を記録 | Claude |

---

**このドキュメントは継続的に更新されます。CLI依存を発見した際は、必ずここに記録してください。**
