# 検証機能テストガイド

## 準備: テストデータの作成

### 1. 階層構造違反のテスト

Claude Codeで以下を実行:

```
新しい要求を追加してください。

タイトル: ユーザー管理機能
説明: ユーザーの登録、編集、削除を行う。また、権限管理も実装する。
優先度: high
カテゴリ: system
type: system
```

この要求は以下の違反を検出します:
- **E5違反**: 複数の関心事（登録、編集、削除、権限管理）が含まれており、単一性スコアが低い
- **E1違反**: 「また」という接続詞が使用されている

### 2. 抽象度違反のテスト

```
新しい要求を2つ追加してください。

1つ目:
タイトル: データ処理システム
説明: システムはデータを適切に処理する
優先度: high
カテゴリ: system
type: system

2つ目:
タイトル: ユーザーID取得API
説明: GET /api/users/:id エンドポイントでユーザーIDを取得する。HTTPステータスコード200を返す。
優先度: high
カテゴリ: system
type: system
refines: [前の要求ID]
```

この2つの要求は**C1違反**を検出します:
- 兄弟要求間で抽象度のばらつきが大きい（1つ目は抽象的、2つ目は具体的）

### 3. MECE違反のテスト

```
新しい要求を3つ追加してください。親要求を1つ、子要求を2つ作成します。

親要求:
タイトル: ユーザー認証
説明: ユーザーのログインとアクセス制御を実現する
優先度: high
カテゴリ: system
type: stakeholder

子要求1:
タイトル: ログイン機能
説明: ユーザーIDとパスワードでログインできる
優先度: high
カテゴリ: system
type: system
refines: [親要求ID]

子要求2:
タイトル: サインイン機能
説明: ユーザーIDとパスワードでサインインできる
優先度: high
カテゴリ: system
type: system
refines: [親要求ID]
```

この要求は**D1違反**を検出します:
- 子要求1と2が意味的に重複している（ログイン ≒ サインイン）

### 4. 品質スタイル違反のテスト

```
新しい要求を追加してください。

タイトル: データ処理
説明: データが適切に処理される。必要に応じて検証が実行される。など
優先度: medium
カテゴリ: system
type: system
```

この要求は以下の違反を検出します:
- **E1違反**: 「適切に」「必要に応じて」「など」という曖昧な表現
- **E2違反**: 「処理される」「実行される」という受動態
- **E3違反**: 主語が不明確（誰が/何が処理するのか）
- **E4違反**: 説明が短すぎる可能性

## 検証の実行

### ステップ1: 要求を追加

上記のテストデータを追加した後:

```
すべての要求を検証してください
```

### ステップ2: 結果の確認

Claude Codeが以下のような結果を返します:

```
## 全要求検証完了

- 総要求数: 7
- 合格: 0 (0.0%)
- 総違反数: 15

検証結果がキャッシュされました。詳細なレポートは `get_validation_report` ツールで取得できます。
```

### ステップ3: 詳細レポートの取得

```
検証レポートをMarkdown形式で取得してください
```

これにより、以下が含まれる詳細レポートが生成されます:
- サマリー（総要求数、合格数、総違反数）
- 違反数別の内訳（エラー、警告、情報）
- ドメイン別の違反数
- 違反のある要求のリスト（スコア順）
- 各違反の詳細と修正提案

### ステップ4: 個別要求の検証

特定の要求を詳細に検証:

```
要求REQ-XXXを検証してください。NLP指標を更新してLLM評価も使用してください。
```

結果例:

```
## 要求検証結果

**要求ID**: REQ-1234567890
**タイトル**: ユーザー管理機能
**検証日時**: 2025/10/19 12:34:56

**結果**: ❌ 違反あり
**品質スコア**: 65/100
**違反数**: 3件

### ⚠️ 警告 (2件)

**[E5] 単一性スコアが低いです（0.45 < 0.7）**
- 1つの要求に複数の関心事が含まれている可能性があります
- 💡 接続詞（「また」「さらに」「および」など）で繋がれた内容を別の要求に分割してください

**[E1] 曖昧な表現が検出されました: "また"**
- "また"のような曖昧な表現は具体的な記述に置き換えてください
- 💡 具体的な条件、範囲、または例を記載してください

### ℹ️ 情報 (1件)

**[E3] 主語が明示されていません**
- 「誰が/何が」を明確にすることで要求の責任範囲が明確になります
- 💡 「システムは〜」「ユーザーは〜」などの主語を追加してください
```

## 検証ルールの確認

### 現在有効なルール一覧

validation-rules.jsonc ファイルに20個のルールが定義されています:

```bash
cat validation-rules.jsonc
```

### ルールの有効/無効切り替え

validation-rules.jsonc を編集:

```jsonc
{
  "id": "E1",
  "enabled": false,  // falseに変更すると無効化
  // ...
}
```

サーバーを再起動すると変更が反映されます。

## NLP指標の確認

要求に自動的に追加されるNLP指標を確認:

```
要求REQ-XXXを取得してください
```

結果に以下のフィールドが追加されています:

```json
{
  "id": "REQ-1234567890",
  "title": "...",
  "description": "...",
  "length_tokens": 42,
  "abstraction_score": 0.65,
  "atomicity_score": 0.45,
  "last_validated_at": "2025-10-19T12:34:56.789Z"
}
```

## トラブルシューティング

### ValidationEngine is not initialized yet

サーバー起動直後はエンジンの初期化に数秒かかります。以下のメッセージが表示されるまで待ってください:

```
ValidationEngine initialized
```

### ルールが読み込めない

validation-rules.jsonc のJSON構文エラーをチェック:

```bash
cd requirements-mcp-server
node -e "console.log(JSON.parse(require('fs').readFileSync('validation-rules.jsonc', 'utf-8').split('\n').filter(l => !l.trim().startsWith('//')).join('\n')))"
```

## 高度な使用例

### カスタムルールの追加

validation-rules.jsonc に新しいルールを追加:

```jsonc
{
  "rules": {
    "quality_style": [
      // 既存のルール...
      {
        "id": "E6",
        "domain": "quality_style",
        "name": "数値の明示",
        "description": "性能要件では具体的な数値を記載する",
        "severity": "warning",
        "enabled": true,
        "parameters": {
          "requireNumeric": true
        }
      }
    ]
  }
}
```

### 検証結果のエクスポート

JSON形式で検証結果を取得:

```
検証レポートをJSON形式で取得してください
```

結果をファイルに保存して分析に使用できます。

## まとめ

検証機能は以下の5つのドメインで20個のルールを提供します:

- **A. 階層**: レベル間関係、親存在、循環参照、最大深度
- **B. グラフヘルス**: DAG、ファンアウト、孤立、競合対称性、重複妥当性
- **C. 抽象度**: 兄弟一貫性、親子具体化度差、範囲チェック
- **D. MECE**: 重複検出、カバレッジ、細分化妥当性
- **E. 品質スタイル**: 曖昧表現、受動態、主語明示、長さ、単一性

すべての検証はClaude Codeを通じて対話的に実行できます。
